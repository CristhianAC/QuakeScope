---
import Chart from "./Chart.astro";

interface Props {
  planet: "mars" | "moon";
}

let selectedPlanet: "mars" | "moon" = "moon"; // Planeta seleccionado por defecto

function switchPlanet() {
  selectedPlanet = selectedPlanet === "moon" ? "mars" : "moon";
}
---

<section class="bento-grid mx-40">
  <div class="bento-item" style="--grid-span: 1;">
    <div class="flex justify-center items-center m-4">
      <h2 id="title">Choose the StelarBody: {selectedPlanet === "moon" ? "Moon" : "Mars"}</h2>
    </div>
    <div id="planet" class="planet-container"></div>
    <div class="w-full flex pt-4 justify-center">
      <button id="switchButton" class="" >Switch</button>
    </div>
  </div>

  <div class="bento-item" style="--grid-span: 2;">
    <!-- Pasa el planeta seleccionado como prop al componente Chart -->
    <Chart planet={selectedPlanet} />
  </div>

  <div class="bento-item" style="--grid-span: 1;">
    <h2>Other Celestial Bodies</h2>
    <p>
      Explore various celestial bodies in our solar system, including Mars,
      Jupiter, and more!
    </p>
  </div>
</section>


<style>
  .bento-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px; /* Espacio entre los elementos */
    padding: 20px;
    background-color: var(--background-color); /* Fondo del grid */
  }

  .bento-item {
    background-color: var(--card-background); /* Fondo de la tarjeta */
    color: var(--text-color); /* Texto blanco */
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    transition: transform 0.3s;
    grid-column: span var(--grid-span);
  }

  .bento-item:hover {
    transform: scale(1.05); /* Efecto de hover */
  }

  .planet-container {
    height: 200px; /* Ajusta según el tamaño deseado */
    position: relative;
    overflow: hidden; /* Evita que el canvas sobresalga */
  }

  .planet-container canvas {
    width: 100%;
    height: 100%;
    display: block; /* Asegura que el canvas no tenga espacios vacíos */
  }
</style>
<script>
  import * as THREE from "three";
  document.addEventListener("astro:page-load", () => {
    let moonSelected = true;

    const reducedMotion = window.matchMedia("(prefers-reduced-motion: reduce)");
    if (!reducedMotion.matches) {
      const $planet = document.getElementById("planet");
      const $title = document.getElementById("title");
      if (moonSelected) {
          $title!.textContent = "Choose the StelarBody: Moon";
        } else {
          $title!.textContent = "Choose the StelarBody: Mars";
        }
      const $switchButton = document.getElementById("switchButton");
      $switchButton?.addEventListener("click", () => {
        moonSelected = !moonSelected;
        switchCelestialBody();
      });

      let w = $planet!.offsetWidth;
      let h = $planet!.offsetHeight;

      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(85, w / h, 0.08, 4000);
      camera.position.z = 15;
      scene.add(camera);
      const renderer = new THREE.WebGLRenderer();
      renderer.setSize(w, h);
      renderer.setClearColor(0x00000, 1);

      $planet?.appendChild(renderer.domElement);

      const light = new THREE.DirectionalLight(0xffffff, 0.8);
      light.position.set(1, 1, 1);
      light.castShadow = true;
      //Set up shadow properties for the light
      light.shadow.mapSize.width = 512; // default
      light.shadow.mapSize.height = 512; // default
      light.shadow.camera.near = 0.5; // default
      light.shadow.camera.far = 500; // default
      scene.add(light);
      const loader = new THREE.TextureLoader();
      loader.crossOrigin = "";
      let moonSphere: any, marsSphere: any;

      loader.load("/Moon.jpg", (texture) => {
        const geometry = new THREE.SphereGeometry(5, 32, 32);
        const material = new THREE.MeshStandardMaterial({ map: texture });

        moonSphere = new THREE.Mesh(geometry, material);
        moonSphere.castShadow = true; //default is false
        scene.add(moonSphere);
        animate();
      });

      loader.load("/Mars.webp", (texture) => {
        const geometry = new THREE.SphereGeometry(5, 42, 32);
        const material = new THREE.MeshStandardMaterial({ map: texture });
        marsSphere = new THREE.Mesh(geometry, material);
        marsSphere.castShadow = true; //default is false
        marsSphere.position.x = 100;
        scene.add(marsSphere);
      });

      function animate() {
        requestAnimationFrame(animate);
        if (moonSphere) moonSphere.rotation.y += 0.001;
        if (marsSphere) marsSphere.rotation.y += 0.001;
        renderer.render(scene, camera);
      }

      function switchCelestialBody() {
        const duration = 1000; // Duration of the transition in milliseconds
        const start = performance.now();
        if (moonSelected) {
          $title!.textContent = "Choose the StelarBody: Moon";
        } else {
          $title!.textContent = "Choose the StelarBody: Mars";
        }
        const initialMoonX = moonSphere.position.x;
        const initialMarsX = marsSphere.position.x;
        const targetMoonX = moonSelected ? 0 : -100;
        const targetMarsX = moonSelected ? 100 : 0;

        function animateTransition(now: any) {
          const elapsed = now - start;
          const progress = Math.min(elapsed / duration, 1);

          moonSphere.position.x =
            initialMoonX + (targetMoonX - initialMoonX) * progress;
          marsSphere.position.x =
            initialMarsX + (targetMarsX - initialMarsX) * progress;

          if (progress < 1) {
            requestAnimationFrame(animateTransition);
          }
        }

        requestAnimationFrame(animateTransition);
      }

      function resize() {
        h = $planet!.offsetHeight;
        w = $planet!.offsetWidth;
        camera.aspect = w / h;
        camera.updateProjectionMatrix();
        renderer.setSize(w, h);
      }

      window.addEventListener("resize", resize);
    }
  });
</script>
